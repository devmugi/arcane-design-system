name: Screenshot Diff Comment

# This workflow posts a comment on PRs when screenshot verification fails
# It downloads the diff artifacts and creates a visual comparison comment

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]

permissions:
  pull-requests: write
  actions: read

jobs:
  comment-on-failure:
    name: Post Screenshot Diff Comment
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Download Android Screenshot Diffs
        uses: actions/download-artifact@v4
        with:
          name: screenshot-diffs-android
          path: diffs/android
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check for Diff Files
        id: check-diffs
        run: |
          if [ -d "diffs" ] && [ "$(find diffs -name '*_compare.png' -o -name '*_diff.png' 2>/dev/null | head -1)" ]; then
            echo "has_diffs=true" >> $GITHUB_OUTPUT
            echo "Found screenshot diffs"
            find diffs -name '*.png' | head -20
          else
            echo "has_diffs=false" >> $GITHUB_OUTPUT
            echo "No screenshot diffs found"
          fi

      - name: Get PR Number
        id: pr
        if: steps.check-diffs.outputs.has_diffs == 'true'
        run: |
          # Get the PR number from the workflow run
          PR_NUMBER=$(gh run view ${{ github.event.workflow_run.id }} --json headBranch -q '.headBranch' | xargs -I {} gh pr list --head {} --json number -q '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Comment Body
        id: comment
        if: steps.check-diffs.outputs.has_diffs == 'true' && steps.pr.outputs.number
        run: |
          cat << 'EOF' > comment.md
          ## ðŸ“¸ Screenshot Verification Failed

          The following screenshots have visual differences from the golden images:

          <details>
          <summary>View Changed Screenshots</summary>

          EOF

          # List changed files
          find diffs -name '*_compare.png' -o -name '*_diff.png' 2>/dev/null | while read file; do
            basename=$(basename "$file" | sed 's/_compare.png//' | sed 's/_diff.png//')
            echo "- \`$basename\`" >> comment.md
          done

          cat << 'EOF' >> comment.md

          </details>

          ### How to Review

          1. Download the `screenshot-diffs-android` artifact from the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
          2. Review the `*_compare.png` files which show before/after side-by-side
          3. If changes are intentional, update golden images by running:
             ```bash
             ./gradlew recordRoborazziDebug
             ```
          4. Commit the updated golden images

          ---
          *This comment was automatically generated by the Screenshot Diff workflow.*
          EOF

          # Set output
          echo "body<<EOFBODY" >> $GITHUB_OUTPUT
          cat comment.md >> $GITHUB_OUTPUT
          echo "EOFBODY" >> $GITHUB_OUTPUT

      - name: Post Comment
        if: steps.check-diffs.outputs.has_diffs == 'true' && steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const body = `${{ steps.comment.outputs.body }}`;

            // Check for existing comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ“¸ Screenshot Verification Failed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
